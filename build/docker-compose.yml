version: '3.9'

services:
    antihero-bot:
        working_dir: /antihero_bot
        build:
            context: ../
            dockerfile: ./build/Dockerfile
        command: python -m src.bot
        depends_on:
            - antihero-redis
        user: "1000:1000"
        restart: unless-stopped
        container_name: antihero-bot
        env_file: ../.env
        ports:
            - "172.17.0.1:8081:8081"
        networks:
            antihero:
                aliases:
                    - antihero-bot

    antihero-migrations:
        build:
          context: ../
          dockerfile: ./build/Dockerfile
        command: alembic upgrade head
        user: "1000:1000"
        restart: "no"
        container_name: antihero-migrations
        env_file: ../.env
        networks:
            antihero:
                aliases:
                    - antihero-migrations

    antihero-withdrawal_processor:
        build:
            context: ../
            dockerfile: ./build/Dockerfile
        command: python -m src.services.withdrawal_processor
        user: "1000:1000"
        restart: unless-stopped
        container_name: antihero-withdrawal_processor
        env_file: ../.env
        networks:
            antihero:
                aliases:
                    - antihero-withdrawal_processor

    antihero-game_processor:
        build:
            context: ../
            dockerfile: ./build/Dockerfile
        command: python -m src.services.game_processor
        user: "1000:1000"
        restart: unless-stopped
        container_name: antihero-game_processor
        env_file: ../.env
        networks:
            antihero:
                aliases:
                    - antihero-game_processor

    antihero-redis:
        image: redis:latest
        container_name: antihero-redis
        volumes:
          - ./redis-data:/data:rw
        restart: unless-stopped
        user: "1000:1000"
        expose:
            - "6379"
        networks:
            antihero:
                aliases:
                    - antihero-redis

    antihero-web:
        build:
            context: ../
            dockerfile: ./build/Dockerfile
        command: python -m src.web
        user: "1000:1000"
        restart: unless-stopped
        container_name: antihero-web
        env_file: ../.env
        ports:
            - "172.17.0.1:8082:8082"
        networks:
            antihero:
                aliases:
                    - antihero-web
networks:
    antihero:
        driver: bridge
        ipam:
            config:
                - subnet: 10.0.1.0/24